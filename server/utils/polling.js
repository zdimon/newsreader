// Generated by CoffeeScript 1.11.1
(function() {
  var download_image, fs, get_new_issues_json, get_top_from_remote, http, issues_polling, makeresponse, path, polling, poolling, process_issues, request, top_polling, utils;

  polling = require('async-polling');

  http = require('http');

  global.remote_host = 'pressa.ru';

  fs = require('fs');

  path = require('path');

  utils = require('../utils/utils');

  request = require('request');

  makeresponse = function(options, onResult) {
    var dest;
    dest = path.join(global.app_root, global.app_config.data_dir, "top10/" + (utils.getNowDate()) + ".json");
    return fs.stat(dest, function(err, stat) {
      var req;
      if (err !== null) {
        console.log('Requesting....');
        req = http.get(options, function(res) {
          var out;
          out = '';
          res.on('data', function(chunk) {
            return out = out + chunk;
          });
          return res.on('end', function() {
            var jsdata;
            jsdata = JSON.parse(out);
            download_image(jsdata);
            if (parseInt(Object.keys(jsdata.articles).length) > 9) {
              fs.writeFile(dest, out, function(err) {
                if (err) {
                  console.log(err);
                }
                return console.log("The file " + dest + " was saved!");
              });
            }
            return onResult(res.statusCode, out);
          });
        });
        req.on('socket', function(socket) {
          socket.setTimeout(10000);
          return socket.on('timeout', function() {
            return req.abort();
          });
        });
        return req.on('error', function(err) {
          if (err.code === 'ECONNRESET') {
            return console.log('Timeour occurs');
          }
        });
      }
    });
  };

  get_top_from_remote = function(end) {
    var options;
    options = {
      host: global.remote_host,
      path: "/mts/api/top10/" + (utils.getNowDate()) + ".json"
    };
    makeresponse(options, function(code, res) {
      return console.log("Request is compleated with code " + code);
    });
    return end();
  };

  download_image = function(jsdata) {
    var date_dir, i, image_path, j, len, ref, results;
    date_dir = path.join(global.app_root, global.app_config.data_dir, 'top10', 'images', jsdata.date);
    if (!fs.existsSync(date_dir)) {
      console.log("Creating " + date_dir);
      fs.mkdirSync(date_dir);
    }
    ref = jsdata.articles;
    results = [];
    for (j = 0, len = ref.length; j < len; j++) {
      i = ref[j];
      image_path = path.join(date_dir, i.id + ".png");
      console.log(i.small_image);
      results.push(request(i.small_image).pipe(fs.createWriteStream(image_path)).on('close', function() {
        return console.log("saved " + i.small_image);
      }));
    }
    return results;
  };

  get_new_issues_json = function(callback) {
    var options, req;
    console.log('Getting new issues...');
    options = {
      host: global.remote_host,
      path: "/zd/new.json"
    };
    return req = http.get(options, function(res) {
      var out;
      out = '';
      res.on('data', function(chunk) {
        return out = out + chunk;
      });
      return res.on('end', function() {
        var jsdata;
        jsdata = JSON.parse(out);
        return callback(jsdata);
      });
    });
  };

  process_issues = function() {
    return get_new_issues_json(function(res) {
      var issue_covers_dir, issue_dir, issue_page_dir, journal_dir, k, results, v;
      results = [];
      for (k in res) {
        v = res[k];
        journal_dir = path.join(global.app_root, global.app_config.data_dir, 'journals', "" + v.journal_id);
        if (!fs.existsSync(journal_dir)) {
          console.log("Creating " + journal_dir);
          fs.mkdirSync(journal_dir);
        }
        issue_dir = path.join(journal_dir, "" + v.id);
        if (!fs.existsSync(issue_dir)) {
          console.log("Creating " + issue_dir);
          fs.mkdirSync(issue_dir);
        }
        issue_page_dir = path.join(issue_dir, "pages");
        if (!fs.existsSync(issue_page_dir)) {
          console.log("Creating " + issue_page_dir);
          fs.mkdirSync(issue_page_dir);
        }
        issue_covers_dir = path.join(issue_dir, "thumbnails");
        if (!fs.existsSync(issue_covers_dir)) {
          console.log("Creating " + issue_covers_dir);
          fs.mkdirSync(issue_covers_dir);
        }
        results.push(request(v.thumb).pipe(fs.createWriteStream(issue_dir + "/cover.png")).on('close', function() {}));
      }
      return results;
    });
  };

  top_polling = polling(get_top_from_remote, 60000 * 30);

  top_polling.run();

  issues_polling = polling(process_issues, 60000 * 30);

  issues_polling.run();

  poolling = {
    get_top_from_remote: get_top_from_remote
  };

  module.exports = poolling;

}).call(this);
