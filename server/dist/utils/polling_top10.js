// Generated by CoffeeScript 1.9.3
(function() {
  var crop, done_path, download_image, easyimg, fs, getTop10FromFS, get_top10_from_server, http, log, makeresponse, out, path, request, requestSync, utils;

  http = require('http');

  fs = require('fs');

  path = require('path');

  utils = require('../utils/utils');

  request = require('request');

  log = require('winston-color');

  log.level = process.env.LOG_LEVEL;

  log.debug("Importing pooling top 10 module");

  easyimg = require('easyimage');

  requestSync = require('sync-request');

  done_path = path.join(global.app_root, global.app_config.data_dir, 'done.json');

  makeresponse = function(options, onResult) {
    var dest;
    dest = path.join(global.app_root, global.app_config.data_dir, "top10/" + (utils.getNowDate()) + ".json");
    return fs.stat(dest, function(err, stat) {
      var req;
      if (err !== null) {
        console.log('Requesting....');
        req = http.get(options, function(res) {
          var out;
          out = '';
          res.on('data', function(chunk) {
            return out = out + chunk;
          });
          return res.on('end', function() {
            var jsdata;
            jsdata = JSON.parse(out);
            download_image(jsdata);
            if (parseInt(Object.keys(jsdata.articles).length) > 9) {
              fs.writeFile(dest, out, function(err) {
                if (err) {
                  log.error(err);
                }
                return console.log("The file " + dest + " was saved!");
              });
            }
            return onResult(res.statusCode, out);
          });
        });
        req.on('socket', function(socket) {
          socket.setTimeout(10000);
          return socket.on('timeout', function() {
            return req.abort();
          });
        });
        return req.on('error', function(err) {
          if (err.code === 'ECONNRESET') {
            return console.log('Timeour occurs');
          }
        });
      }
    });
  };

  get_top10_from_server = function(end) {
    var options;
    log.debug("TOP10: start");
    options = {
      host: global.remote_host,
      path: "/mts/api/top10/" + (utils.getNowDate()) + ".json"
    };
    makeresponse(options, function(code, res) {
      return console.log("Request is compleated with code " + code);
    });
    return end();
  };

  download_image = function(jsdata) {
    var date_dir, i, image_date_dir, image_path, image_path_crop, j, len, ref, res, results;
    date_dir = path.join(global.app_root, global.app_config.data_dir, 'top10', 'images', jsdata.date);
    image_date_dir = path.join(global.app_root, global.app_config.data_dir, 'top10', 'images');
    if (!fs.existsSync(image_date_dir)) {
      log.verbose("debug", "Creating " + image_date_dir);
      fs.mkdirSync(image_date_dir);
    }
    if (!fs.existsSync(date_dir)) {
      log.verbose("debug", "Creating " + date_dir);
      fs.mkdirSync(date_dir);
    }
    ref = jsdata.articles;
    results = [];
    for (j = 0, len = ref.length; j < len; j++) {
      i = ref[j];
      image_path = path.join(date_dir, i.id + ".png");
      image_path_crop = path.join(date_dir, i.id + "_crop.png");
      res = requestSync('GET', i.small_image);
      fs.writeFileSync(image_path, res.getBody());
      res = requestSync('GET', i.small_image_square);
      fs.writeFileSync(image_path_crop, res.getBody());
      results.push(log.verbose("saved " + i.small_image));

      /*
      opt = {
          src: image_path,
          dst: image_path_crop,
          x: 0,
          y:0,
          cropwidth:80,
          cropheight:80
      }                
      easyimg.crop(opt).then (file)->
          log.debug "Image croped #{file.width}x#{file.height}"
      , (err)->
          console.log err
       */
    }
    return results;
  };

  getTop10FromFS = function(offset) {
    var cont, date, dest;
    if (offset == null) {
      offset = 0;
    }
    date = utils.getNowDate(offset);
    try {
      dest = path.join(global.app_root, global.app_config.data_dir, "top10/" + date + ".json");
      return cont = JSON.parse(fs.readFileSync(dest, 'utf8'));
    } catch (_error) {
      offset = offset + 1;
      return getTop10FromFS(offset);
    }
  };

  crop = function() {
    var date, i, jsdata, opt, path_img, path_img_crop, ref, results, v;
    log.debug("Cropping");
    jsdata = getTop10FromFS();
    date = jsdata.date;
    ref = jsdata.articles;
    results = [];
    for (i in ref) {
      v = ref[i];
      path_img = path.join(global.app_root, global.app_config.data_dir, "top10/images/" + date + "/" + v.id + ".png");
      path_img_crop = path.join(global.app_root, global.app_config.data_dir, "top10/images/" + date + "/" + v.id + "_crop.png");
      opt = {
        src: path_img,
        dst: path_img,
        x: 0,
        y: 0,
        cropwidth: 80,
        cropheight: 80
      };
      easyimg.crop(opt).then(function(file) {
        return log.debug("Imege croped " + file.width + "x" + file.height);
      }, function(err) {
        return console.log(err);
      });
      results.push(console.log(path_img));
    }
    return results;
  };

  out = {
    get_top10_from_server: get_top10_from_server,
    crop: crop
  };

  module.exports = out;

}).call(this);
